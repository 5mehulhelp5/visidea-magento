<?php
try {
    /** @var \Inferendo\Visidea\Helper\Data $helper */
    $helper = $block->helper();
    if (!$helper || !$helper->isEnabled()) {
        return;
    }

    $public_token = $helper->getConfig('general', 'public_token') ?: '';
    $website = $helper->getConfig('general', 'website') ?: '';

    $currentFullAction = method_exists($block, 'getRequest') && $block->getRequest()
        ? $block->getRequest()->getFullActionName()
        : '';

    $user_id = method_exists($block, 'isLoggedIn') && $block->isLoggedIn()
        ? $block->getCustomerId()
        : '';

    $product_id = 0;
    if ($currentFullAction === 'catalog_product_view' && method_exists($block, 'getCurrentProduct')) {
        $currentProduct = $block->getCurrentProduct();
        if ($currentProduct && method_exists($currentProduct, 'getId')) {
            $product_id = $currentProduct->getId();
        }
    }

    $page = match ($currentFullAction) {
        'cms_index_index' => 'home',
        'catalog_product_view' => 'product',
        'checkout_cart_index' => 'cart',
        'checkout_onepage_success' => 'order',
        default => 'other',
    };

    $language = method_exists($block, 'getLanguage') ? $block->getLanguage() : 'en';
    $cartProductIdsString = ($page === 'cart' && method_exists($helper, 'getCartProductIds'))
        ? $helper->getCartProductIds()
        : '';
    $storeId = method_exists($block, 'getStoreId') ? $block->getStoreId() : '';

    $escaper = $block->getEscaper();
    ?>
    <?php if ($page === 'home'): ?>
        <div class="visidea-recommendations"
            language="<?= $escaper->escapeHtmlAttr($language); ?>"
            page="home"
            user_id="<?= $escaper->escapeHtmlAttr($user_id); ?>">
        </div>
    <?php endif; ?>

    <?php if ($page === 'product'): ?>
        <div class="visidea-recommendations"
            language="<?= $escaper->escapeHtmlAttr($language); ?>"
            page="product"
            user_id="<?= $escaper->escapeHtmlAttr($user_id); ?>"
            item_id="<?= $escaper->escapeHtmlAttr($product_id); ?>">
        </div>
        <meta class="visidea-interaction"
            type="item"
            user_id="<?= $escaper->escapeHtmlAttr($user_id); ?>"
            item_id="<?= $escaper->escapeHtmlAttr($product_id); ?>"/>
    <?php endif; ?>

    <?php if ($page === 'cart'): ?>
        <div class="visidea-recommendations"
            language="<?= $escaper->escapeHtmlAttr($language); ?>"
            page="cart"
            user_id="<?= $escaper->escapeHtmlAttr($user_id); ?>"
            item_id="<?= $escaper->escapeHtmlAttr($cartProductIdsString); ?>">
        </div>
    <?php endif; ?>

    <?php if ($page === 'order'): ?>
        <div class="visidea-recommendations"
            language="<?= $escaper->escapeHtmlAttr($language); ?>"
            page="order"
            user_id="<?= $escaper->escapeHtmlAttr($user_id); ?>">
        </div>
    <?php endif; ?>

    <div class="visidea-search-bar"
        language="<?= $escaper->escapeHtmlAttr($language); ?>"
        user_id="<?= $escaper->escapeHtmlAttr($user_id); ?>">
    </div>

    <script>
        require(["Visidea"], function (Visidea) {
            window.visidea(
                "<?= $escaper->escapeJs($website); ?>",
                "<?= $escaper->escapeJs($public_token); ?>",
                "<?= $escaper->escapeJs($language); ?>",
                "<?= $escaper->escapeJs($storeId); ?>"
            );
        });
    </script>
    <?php
} catch (\Throwable $e) {
    // Prevent fatal rendering errors in Marketplace tests
    return;
}
?>
